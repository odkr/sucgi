dnl Template for the makefile.
dnl
dnl Edit this file, NOT the makefile itself.
dnl Then run ./configure to generate or ./config.status to update it.
dnl See docs/build.rst for details.
dnl
ifdef(`__srcdir', `include(__srcdir/macros.m4)', `include(`macros.m4')')dnl
.POSIX:

dnl FIXME: check scripts won't work in any other directory but the source dir
dnl because they won't know where utilities and binaries are!

#
# DO NOT EDIT THIS FILE! IT WILL GET OVERWRITTEN!
#
# This file has been automatically generated by ./configure.
# Edit makefile.in instead and then run ./config.status to update this file.
# See docs/build.md for details.
#

#
# Special targets
#

all: sucgi

.PHONY: all dist distcheck distclean \
	install install-strip installdirs uninstall \
	tidy mostlyclean clean mrproper maintainer-clean \
	check analysis shellcheck

.IGNORE: analysis shellcheck

.SUFFIXES:


#
# Flags and tools
#

SHELL = /bin/sh
ifnempty(`__CC', `dnl
CC = __CC
')dnl
CFLAGS = default(`__CFLAGS', `-O1')
ifnempty(`__ARFLAGS', `dnl
ARFLAGS = __ARFLAGS
')dnl
ifnempty(`__AR', `dnl
AR = __AR
')dnl
ifnempty(`__LDFLAGS', `dnl
LDFLAGS = __LDFLAGS
')dnl
ifnempty(`__LDLIBS', `dnl
LDLIBS = __LDLIBS
')dnl
ifnempty(`__pieflags', `dnl
pieflags = __pieflags
')dnl


#
# Build configuration
#

srcdir = default(`__srcdir', `.')

confdir = $(srcdir)/conf

configs = $(confdir)/devel.env $(confdir)/prod.env \
	$(confdir)/posix.env $(confdir)/unsafe.env

makefile: $(configs) $(srcdir)/makefile.in

compat.h: $(configs) $(srcdir)/compat.h.in

makefile:
	if [ -e config.status ]; then ./config.status --gen=$@; fi

compat.h:
	[ -e config.status ] && \
./config.status --gen=$@ || \
m4 -D__srcdir='$(srcdir)' $(srcdir)/$@.in >$@


#
# Build
#

libs = libsucgi.a

hdrs = compat.h config.h $(srcdir)/attr.h $(srcdir)/macros.h \
	$(srcdir)/params.h $(srcdir)/types.h

objs = env.o error.o groups.o handler.o pair.o path.o priv.o str.o userdir.o

flags = $(CFLAGS) $(pieflags)

.SUFFIXES: .c .o

sucgi: $(srcdir)/main.c $(hdrs) $(libs)

libsucgi.a: $(objs)

env.o: $(srcdir)/env.c $(srcdir)/env.h

error.o: $(srcdir)/error.c $(srcdir)/error.h

groups.o: $(srcdir)/groups.c $(srcdir)/groups.h

pair.o: $(srcdir)/pair.c $(srcdir)/pair.h

path.o: $(srcdir)/path.c $(srcdir)/path.h

priv.o: $(srcdir)/priv.c $(srcdir)/priv.h

handler.o: $(srcdir)/handler.c $(srcdir)/handler.h

str.o: $(srcdir)/str.c $(srcdir)/str.h

userdir.o: $(srcdir)/userdir.c $(srcdir)/userdir.h

$(objs): $(hdrs)

sucgi:
	$(CC) $(LDFLAGS) $(flags) -o$@ $(srcdir)/main.c $(libs) $(LDLIBS)

libsucgi.a: $(objs)
	$(AR) $(ARFLAGS) $@ $?

$(objs):
	$(CC) $(LDFLAGS) $(CFLAGS) -c -o$@ $(srcdir)/$*.c $(LDLIBS)


#
# Documentation
#

manext = default(`__manext', `8')

egypt = egypt

pandoc = pandoc

.SUFFIXES: .$(manext) .gv .md .pdf .svg

man/sucgi.$(manext): man/sucgi.md

.gv.svg:
	dot -Tsvg -o$@ $<

.gv.pdf:
	dot -Tpdf -o$@ $<

.md.$(manext):
	$(pandoc) -Mdate="$$(date +"%B %d, %Y")" -stman -o$@ $(pandocflags) $<

egyptcflags = -DNDEBUG -O0 -fno-inline-functions

docs/callgraph.gv: $(srcdir)/main.c $(objs:.o=.c)
	$(MAKE) CFLAGS="-fdump-rtl-expand $(egyptcflags)" clean all
	$(egypt) --callees main $(egyptflags) *.expand >$@

docs/callgraph.pdf: docs/callgraph.gv

docs/callgraph.svg: docs/callgraph.gv


#
# Installation
#

ifhascmd(`install', `dnl
INSTALL = install
INSTALL_PROGRAM = $(INSTALL)
', `dnl
INSTALL = cp -p
INSTALL_PROGRAM = $(INSTALL)
')dnl
ifnempty(`__DESTDIR', `DESTDIR = __DESTDIR
')dnl
PREFIX = default(`__PREFIX', `/usr/local')
wwwgrp = default(`__wwwgrp', `www-data')
cgidir = default(`__cgidir', `/usr/lib/cgi-bin')
prefix = default(`__prefix', `$(PREFIX)')
exec_prefix = default(`__exec_prefix', `$(prefix)')
libexecdir = default(`__libexecdir', `$(exec_prefix)/libexec')
datarootdir = default(`__datarootdir', `$(prefix)/share')
mandir = default(`__mandir', `$(datarootdir)/man')
man8dir = default(`__man8dir', `$(mandir)/man8')

install: installdirs $(libexecdir)/sucgi $(cgidir)/sucgi

# sucgi is compiled with -s at any rate.
install-strip: install

$(libexecdir)/sucgi: sucgi

$(cgidir)/sucgi:

$(libexecdir)/sucgi:
	chmod u=rwx,go= sucgi
	$(INSTALL_PROGRAM) sucgi $(DESTDIR)$(libexec)
	chown 0:$(wwwgrp) $(DESTDIR)$(libexecdir)/sucgi
	chmod u=rws,g=x,o= $(DESTDIR)$(libexecdir)/sucgi

$(cgidir)/sucgi:
	ln -s $(DESTDIR)$(libexecdir)/sucgi $(DESTDIR)$(cgidir)/sucgi

installdirs:
	mkdir -pm0755 $(DESTDIR)$(cgidir) $(DESTDIR)$(libexecdir)

uninstall:
	rm -f $(DESTDIR)$(libexecdir)/sucgi $(DESTDIR)$(cgidir)/sucgi


#
# Utilities
#

utilsdir = utils

runpara = $(utilsdir)/runpara

uids = $(utilsdir)/uids

utils = $(runpara) $(utilsdir)/uids

$(utils): $(utilsdir)

$(utilsdir): $(utilsdir)/.sentinel

$(utils):
	$(CC) $(LDFLAGS) $(CFLAGS) $(pieflags) -o$@ $(srcdir)/$@.c $(LDLIBS)

$(utilsdir)/.sentinel:
	mkdir -p $(utilsdir)
	touch $@


#
# Scripts
#

scriptsdir = scripts

$(scriptsdir)/libutil.sh: $(utilsdir)/uids


#
# Tests
#

checkdir = tests

$(checkdir): $(checkdir)/.sentinel

$(checkdir)/.sentinel:
	mkdir -p $(checkdir)
	touch $@

# tests/libutil.a
libutil = $(checkdir)/libutil.a

libutildir = $(checkdir)/libutil

libutilsrcdir = $(srcdir)/$(libutildir)

libutilobjs = $(libutildir)/abort.o $(libutildir)/array.o \
	$(libutildir)/dir.o $(libutildir)/path.o $(libutildir)/sigs.o \
	$(libutildir)/str.o $(libutildir)/tmpdir.o $(libutildir)/user.o

$(libutil): $(libutilobjs)

$(libutildir)/abort.o: $(libutilsrcdir)/abort.c $(libutilsrcdir)/abort.h

$(libutildir)/array.o: $(libutilsrcdir)/array.c $(libutilsrcdir)/array.h

$(libutildir)/dir.o: $(libutilsrcdir)/dir.c $(libutilsrcdir)/dir.h

$(libutildir)/path.o: $(libutilsrcdir)/path.c $(libutilsrcdir)/path.h

$(libutildir)/sigs.o: $(libutilsrcdir)/sigs.c $(libutilsrcdir)/sigs.h

$(libutildir)/str.o: $(libutilsrcdir)/str.c $(libutilsrcdir)/str.h

$(libutildir)/tmpdir.o: $(libutilsrcdir)/tmpdir.c $(libutilsrcdir)/tmpdir.h

$(libutildir)/user.o: $(libutilsrcdir)/user.c $(libutilsrcdir)/user.h

$(libutilobjs): $(libutilsrcdir)/types.h $(libutildir)

$(libutildir): $(checkdir) $(libutildir)/.sentinel

$(libutil):
	$(AR) $(ARFLAGS) $@ $?

$(libutilobjs):
	$(CC) $(LDFLAGS) $(CFLAGS) -c -o$@ $(srcdir)/$*.c $(LDLIBS)

$(libutildir)/.sentinel:
	mkdir -p $(libutildir)
	touch $@

ifnempty(`__sharedflag', `dnl
ifelse(__sharedflag, `-dynamiclib', `dnl
# tests/libmock.dylib
libmock = $(checkdir)/libmock.dylib
', __sharedflag, `-shared', `dnl
# tests/libmock.so
libmock = $(checkdir)/libmock.so
')dnl

libmockdir = $(checkdir)/libmock

libmocksrcdir = $(srcdir)/$(libmockdir)

libmockobjs = $(libmockdir)/mockstd.o

picflags = default(`__picflags')

sharedflag = default(`__sharedflag')

ifcflag(`-fsanitize=', `dnl
# ASan breaks pre-loading on some systems.
libmockflags = $(CFLAGS) $(picflags) -fno-sanitize=all', `dnl
libmockflags = $(CFLAGS) $(picflags)
')

$(libmock): $(libmockobjs)

$(libmockdir)/mockstd.o: $(libmocksrcdir)/mockstd.c $(libmocksrcdir)/mockstd.h

$(libmockobjs): $(libmockdir)

$(libmockdir): $(checkdir) $(libmockdir)/.sentinel

$(libmock):
	$(CC) $(LDFLAGS) $(libmockflags) $(sharedflag) -o$@ \
$(libmockobjs) $(LDLIBS)

$(libmockobjs):
	$(CC) $(LDFLAGS) $(libmockflags) -c -o$@ $(srcdir)/$*.c $(LDLIBS)

$(libmockdir)/.sentinel:
	mkdir -p $(libmockdir)
	touch $@

')dnl

# Unit tests
checksrcdir = $(srcdir)/$(checkdir)

unittests = $(checkdir)/ISSIGNED $(checkdir)/NELEMS $(checkdir)/MAXSVAL \
	$(checkdir)/env_get $(checkdir)/env_is_name \
	$(checkdir)/env_restore $(checkdir)/env_setn \
	$(checkdir)/handler_find $(checkdir)/groups_comp \
	$(checkdir)/pair_find $(checkdir)/path_real \
	$(checkdir)/path_suffix $(checkdir)/path_is_sub \
	$(checkdir)/priv_drop $(checkdir)/priv_suspend \
	$(checkdir)/str_copy $(checkdir)/str_get_fmts \
	$(checkdir)/str_split $(checkdir)/userdir_exp

unitlibs = $(libs) $(libutil)

unitflags = $(CFLAGS) $(pieflags)

$(checkdir)/ISSIGNED: $(checksrcdir)/ISSIGNED.c

$(checkdir)/NELEMS: $(checksrcdir)/NELEMS.c

$(checkdir)/MAXSVAL: $(checksrcdir)/MAXSVAL.c

$(checkdir)/env_get: $(checksrcdir)/env_get.c

$(checkdir)/env_is_name: $(checksrcdir)/env_is_name.c

$(checkdir)/env_restore: $(checksrcdir)/env_restore.c

$(checkdir)/env_setn: $(checksrcdir)/env_setn.c

$(checkdir)/handler_find: $(checksrcdir)/handler_find.c

$(checkdir)/groups_comp: $(checksrcdir)/groups_comp.c

$(checkdir)/pair_find: $(checksrcdir)/pair_find.c

$(checkdir)/path_real: $(checksrcdir)/path_real.c

$(checkdir)/path_suffix: $(checksrcdir)/path_suffix.c

$(checkdir)/path_is_sub: $(checksrcdir)/path_is_sub.c

$(checkdir)/priv_drop: $(checksrcdir)/priv_drop.c

$(checkdir)/priv_suspend: $(checksrcdir)/priv_suspend.c

$(checkdir)/str_copy: $(checksrcdir)/str_copy.c

$(checkdir)/str_get_fmts: $(checksrcdir)/str_get_fmts.c

$(checkdir)/str_split: $(checksrcdir)/str_split.c

$(checkdir)/userdir_exp: $(checksrcdir)/userdir_exp.c

$(unittests): $(unitlibs) $(checkdir)

$(unittests):
	$(CC) $(LDFLAGS) $(unitflags) -o$@ $(srcdir)/$@.c $(unitlibs) $(LDLIBS)

# Utilities for scripted tests
checkutilsdir = $(checkdir)/utils

checkutils = $(checkutilsdir)/badenv $(checkutilsdir)/badexec \
	$(checkutilsdir)/runas

$(checkutils): $(checkutilsdir)

$(checkutilsdir): $(checkdir) $(checkutilsdir)/.sentinel

$(checkutils):
	$(CC) $(LDFLAGS) $(CFLAGS) $(pieflags) -o$@ $(srcdir)/$@.c $(LDLIBS)

$(checkutilsdir)/.sentinel:
	mkdir -p $(checkutilsdir)
	touch $@

# Scripted tests
checkscriptsdir = $(srcdir)/$(checkdir)/scripts

checkscripts = $(checkscriptsdir)/BUG $(checkscriptsdir)/error \
	$(checkscriptsdir)/main

checkscriptbins = $(checkdir)/BUG $(checkdir)/error $(checkdir)/main

checkflags = $(CFLAGS) $(pieflags) -DTESTING

$(checkdir)/BUG: $(checksrcdir)/BUG.c

$(checkdir)/error: $(checksrcdir)/error.c

$(checkdir)/main: $(srcdir)/main.c

$(checkscriptbins): $(libs) $(hdrs) $(libutilsrcdir)/types.h $(checkdir)

$(checkdir)/main:
	$(CC) $(LDFLAGS) $(checkflags) -o$@ $(srcdir)/main.c $(libs) $(LDLIBS)

$(checkdir)/BUG $(checkdir)/error:
	$(CC) $(LDFLAGS) $(checkflags) -o$@ $(srcdir)/$@.c $(libs) $(LDLIBS)

# Execution
checks = $(unittests) $(checkscripts)

ifelse(__uname, `Darwin', `dnl
preload = DYLD_INSERT_LIBRARIES

environ = MallocNanoZone=0
', `dnl
preload = LD_PRELOAD

environ =
')dnl

runparaflags = -ci75 -j8

ifnempty(`__shared', `dnl
check: $(checks) $(checkutils) $(checkscriptbins) $(runpara) $(libmock)
', `dnl
check: $(checks) $(checkutils) $(checkscriptbins) $(runpara)
')dnl

check:
ifnempty(`__shared', `dnl
	[ "$$(id -u)" -eq 0 ] \
&& $(environ) $(runpara) $(runparaflags) $(checks) \
|| $(environ) $(runpara) $(runparaflags) $(preload)=$(libmock) $(checks)
', `dnl
	$(environ) $(runpara) $(runparaflags) $(checks)
')dnl


#
# Code analysis
#

srcs = $(srcdir)/*.h $(srcdir)/*.c $(checksrcdir)/*.c \
	$(libutilsrcdir)/*.h $(libutilsrcdir)/*.c \
	$(libmocksrcdir/*.h $(libmocksrcdir)/*.c

scripts = $(srcdir)/configure $(srcdir)/installc \
	$(scriptsdir)/* $(checkscriptsdir)/*

clangtidy = clang-tidy

clangtidyflags = --quiet

cppcheck = cppcheck

cppcheckflags = --quiet --force --language=c --std=c99 \
	--project=cppcheck/sucgi.cppcheck --library=posix \
	--library=cppcheck/c99.cfg --library=cppcheck/gnuc.cfg \
	--library=cppcheck/posix.cfg --library=cppcheck/bsd.cfg \
	--library=cppcheck/linux.cfg --library=cppcheck/sucgi.cfg \
	--suppress-xml=cppcheck/suppress.xml --inline-suppr \
	--enable=all --addon=cppcheck/cert.py --addon=misra.py

cppcheckbuilddir = cppcheck/build

flawfinder = flawfinder

flawfinderflags = --falsepositive --dataonly --quiet

rats = rats

ratsflags = --resultsonly --quiet --warning 3

shellcheck = shellcheck

shellcheckflags = -x

analysis: compat.h $(cppcheckbuilddir)

$(cppcheckbuilddir): $(cppcheckbuilddir)/.sentinel

analysis:
	$(clangtidy) $(clangtidyflags) $(srcs) -- -std=c99
	$(cppcheck) $(cppcheckflags) $(srcs)
	$(flawfinder) $(flawfinderflags) $(srcs)
	$(rats) $(ratsflags) $(srcs)

shellcheck:
	$(shellcheck) $(shellcheckflags) $(scripts)

$(cppcheckbuilddir)/.sentinel:
	mkdir -p $(cppcheckbuilddir)
	touch $@


#
# Cleanup
#

binaries = sucgi $(utils) $(checkutils) $(unittests) $(checkscriptbins) \
	libsucgi.a $(libutil) $(libmock) $(objs) $(libutilobjs) $(libmockobjs)

maintainer-clean: distclean

distclean: mrproper

mrproper: clean

clean: mostlyclean

mostlyclean: tidy

maintainer-clean: distclean
	rm -f man/sucgi.$(manext) docs/callgraph.*
	rmdir $(cppcheckbuilddir)

distclean:
	rm -f compat.h config.status makefile $(distar)
	rm -rf $(distname)

mrproper: clean
	rm -f $(cppcheckbuilddir)/*
	find . '(' \
	-name '*.gcda' -o \
	-name '*.gcno' -o \
	-name '*.gcov' -o \
	-name '*.info' \
	')' -exec rm -f '{}' +

mostlyclean:
	rm -f $(binaries)

tidy:
	find . '(' \
	-name '*.bak' -o \
	-name '*.ctu-info' -o \
	-name '*.expand' -o \
	-name '*.dump' -o \
	-name '*.log' \
	-name '*.tgz' \
	')' -exec rm -f '{}' +
	find . -type d -name 'tmp-*' -exec rm -rf '{}' +


#
# Distribution
#

package = sucgi
version = syscmd(
	`awk "
		\$1 == \"#define\" && \$2 == \"VERSION\" {
			gsub(/[^0-9.]/, \"\", \$3);
			print \$3;
			exit;
		}
	"' default(`__srcdir', `.')/main.c
)
distname = $(package)-$(version)
distar = $(distname).tgz
distfiles = $(srcdir)/*.c $(srcdir)/*.h $(srcdir)/*.in $(srcdir)/*.m4 \
	$(srcdir)/README.md $(srcdir)/LICENSE.txt \
	$(srcdir)/configure $(srcdir)/installc \
	$(srcdir)/conf $(srcdir)/cppcheck $(srcdir)/docs $(srcdir)/probe \
	$(srcdir)/tests $(srcdir)/utils $(srcdir)/scripts #$(srcdir)/man

dist: $(distar)

distcheck: dist

sigdist: dist $(distar).asc

sigdistcheck: sigdist distcheck

$(distar): $(distname)

$(distar).asc: $(distar)

$(distname): distclean #man/sucgi.8

dist: $(distar)
	rm -rf $(distname)

distcheck:
	tar -xzf $(distar)
	$(distname)/configure
	cd $(distname) && $(MAKE) -e all check dist
	rm -rf $(distname)

$(distname):
	find $(distfiles) -exec pathchk -Pp '{}' +
	mkdir -p $(distname)
	cp -Rp $(distfiles) $(distname)

$(distar):
	tar -X $(srcdir)/conf/dist.excl -czf $(distar) $(distname)

$(distar).asc:
	gpg -qab --batch --yes $(distar)




